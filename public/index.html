<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Dave Ramsey - Test Your Knowledge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #smiley-container {
            transform: translateX(-50px) translateY(-50px);
        }

        .smiley-ghost {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
        }

        @keyframes fadeUp {
            0% {
                transform: translateY(0);
                opacity: 0.5;
            }
            100% {
                transform: translateY(-400px);
                opacity: 0;
            }
        }

        .smiley-ghost.animate {
            animation: fadeUp 0.8s ease-out;
        }
    </style>
</head>
<body class="bg-white p-8 flex flex-col items-center justify-center min-h-screen">
    <div id="smiley-container" class="fixed bottom-4 right-4">
        <div class="smiley-ghost cursor-pointer text-4xl">ðŸ˜Š</div>
        <div class="smiley-ghost cursor-pointer text-4xl">ðŸ˜Š</div>
        <div id="smiley" class="cursor-pointer text-4xl absolute">ðŸ˜Š</div>

    </div>
    <div class=" w-full max-w-xl text-center">
        <h1 class="text-6xl font-bold text-gray-800 mb-2">Play Dave Ramsey</h1>
        <h2 class="text-4xl font-medium text-gray-600 mb-4">Test Your Knowledge</h2>
        <p id="question" class="text-lg text-gray-700 mb-6">
            "My husband and I are on Baby Step 2 with $30,000 left in student loans. We make $80,000 a year and have about $1,000 in our emergency fund. Weâ€™ve been throwing an extra $1,000 a month at our debt. The issue is, my car just died, and repairs would cost more than itâ€™s worth. I need reliable transportation for work, and public transit isnâ€™t an option. Should we pause our debt snowball to save for a used car in the $5,000â€“$7,000 range, or is there a better way to handle this?"
        </p>
        <textarea id="userInput" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none mb-4" placeholder="Enter your answer here..."></textarea>
        <button id="submitButton" onclick="sendMessage()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-xl transition">Submit Answer</button>
        <div class="mt-6">
            <p id="response" class="text-lg text-gray-800 font-medium"></p>
            <button id="shareButton" class="hidden bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl mt-2 transition" onclick="shareScore()">Share Your Score</button>
            <div id="copySuccess" class="hidden mt-4 text-green-500 font-medium">Score copied to clipboard!</div>
            <p id="reason" class="hidden text rounded-lg text-gray-800 p-6 bg-gray-100 border-2 font-medium mt-6"></p>
        </div>
    </div>

    <script>
          const wsUrl = window.location.hostname === 'localhost' 
            ? `ws://${window.location.hostname}:3000`
            : `wss://${window.location.hostname}/ws`;

        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
        };

        ws.onmessage = (event) => {
            event.data.text().then((text) => {
                try {
                    const message = JSON.parse(text);
                    if (message.type === 'smiley-clicked') {
                        animateSmileyGhost();
                        console.log('Smiley clicked event received');
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            });
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };

        ws.onclose = (event) => {
            console.log('WebSocket connection closed:', event);
        };

        document.getElementById("smiley").addEventListener("click", function() {
            if (ws.readyState === WebSocket.OPEN) {
                animateSmileyGhost();
                ws.send(JSON.stringify({ type: 'smiley-clicked' }));
            } else {
                console.error('WebSocket is not open. Ready state: ' + ws.readyState);
            }
        });

        let currentGhostIndex = 0;
        const smileyGhosts = document.querySelectorAll('.smiley-ghost');

        function animateSmileyGhost() {
            const smileyGhost = smileyGhosts[currentGhostIndex];
            smileyGhost.classList.remove("animate");
            void smileyGhost.offsetWidth; // Trigger reflow
            smileyGhost.classList.add("animate");
            currentGhostIndex = (currentGhostIndex + 1) % smileyGhosts.length;
        }

        let latestScore = "";
        let hasAttempted = localStorage.getItem("hasAttempted") === "true";

        window.onload = function () {
            if (hasAttempted) {
                // Restore game state from localStorage
                const storedScore = localStorage.getItem("latestScore");
                const storedReason = localStorage.getItem("latestReason");

                document.getElementById("userInput").style.display = "none";
                document.getElementById("submitButton").style.display = "none";
                document.getElementById("shareButton").classList.remove("hidden");

                if (storedScore) {
                    document.getElementById("response").innerHTML = `<strong>Similarity Score:</strong> ${storedScore}`;
                }
                if (storedReason) {
                    document.getElementById("reason").innerHTML = storedReason;
                    document.getElementById("reason").style.display = "block";
                }

                
            }
        };

        async function sendMessage() {
            if (hasAttempted) {
                alert("You only get one attempt at the game!");
                return;
            }

            hasAttempted = true;
            localStorage.setItem("hasAttempted", "true");

            const userText = document.getElementById("userInput").value;
            const answer = "Dave: Hey, thanks for calling. First off, you and your husband are doing a great jobâ€”paying off $15,000 already shows real commitment. Now, about the carâ€”youâ€™re right not to take on more debt. Since youâ€™re in Baby Step 2, this is exactly what your emergency fund is for. Pause the extra debt payments for now and focus on getting a cheap, reliable car with cash. You donâ€™t need anything fancyâ€”aim for something in the $3,000â€“$5,000 range if you can. Once youâ€™ve got transportation sorted, jump right back into your debt snowball and keep the momentum going. Youâ€™re on the right trackâ€”stay focused, and youâ€™ll be debt-free before you know it.";

            const requestData = {
                messages: [
                    {
                        role: "system",
                        content: `Provide a percentage similarity score (0-100%) based on how close the user's response is to the following statement. If the answer contains a resopnse that would be along with a reason on why you scored that way: ${answer}`
                    },
                    {
                        role: "user",
                        content: userText
                    }
                ]
            };

            try {
                const response = await fetch('/api/chat', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const fullResponse = data.choices[0].message.content.trim();
                const scoreMatch = fullResponse.match(/\d+%?/);
                latestScore = scoreMatch ? scoreMatch[0] : "Unknown Score";
                localStorage.setItem("latestScore", latestScore);
                localStorage.setItem("latestReason", fullResponse);

                document.getElementById("response").innerHTML = `<strong>Similarity Score:</strong> ${latestScore}`;
                document.getElementById("reason").innerHTML = fullResponse;
                document.getElementById("shareButton").classList.remove("hidden");

                document.getElementById("userInput").style.display = "none";
                document.getElementById("submitButton").style.display = "none";
                document.getElementById("reason").style.display = "block";
            } catch (error) {
                document.getElementById("response").innerText = "Error: " + error.message;
            }
        }

        function shareScore() {
    const scoreNumber = parseInt(latestScore);
    let visualScore = "";
    const blocks = Math.round(scoreNumber / 10);
    for (let i = 0; i < blocks; i++) {
        visualScore += "ðŸŸ©";
    }
    for (let i = blocks; i < 10; i++) {
        visualScore += "â¬œ";
    }

    const currentUrl = window.location.href; // Get the current page URL
    const shareText = `What Would Dave Say?\n${visualScore}\nScore: ${latestScore}\nCan you beat my score?\nðŸ’ª #DaveRamseyChallenge\nPlay here: ${currentUrl}`;

    navigator.clipboard.writeText(shareText).then(() => {
        document.getElementById("copySuccess").classList.remove("hidden");
        setTimeout(() => document.getElementById("copySuccess").classList.add("hidden"), 3000);
    }).catch(err => {
        alert("Failed to copy score. Please try again.");
    });
}

    </script>
</body>
</html>
